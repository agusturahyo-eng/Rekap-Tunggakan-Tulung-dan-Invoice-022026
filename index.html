<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Rekap Tunggakan & Invoice ULP Tulung</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body{background:#f4f6f9; font-family: sans-serif;}
        .clickable{cursor:pointer; user-select: none;}
        tr:hover{background:#eef3ff}
        .table-primary th:hover { background-color: #0d6efd !important; color: white; }
        .card.highlight { border: 2px solid #0d6efd; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .card-body p { margin-bottom: 2px; line-height: 1.2; font-size: 0.85rem; }
    </style>
</head>
<body>
<div class="container my-3">
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item"><a class="nav-link active" id="tab-lembar1" onclick="loadSheet('lembar1')">Lembar 1</a></li>
        <li class="nav-item"><a class="nav-link" id="tab-lembar2" onclick="loadSheet('lembar2')">Lembar 2</a></li>
        <li class="nav-item"><a class="nav-link" id="tab-lembar3" onclick="loadSheet('lembar3')">Lembar 3</a></li>
        <li class="nav-item"><a class="nav-link" id="tab-invoice" onclick="loadSheet('invoice')">Invoice</a></li>
    </ul>
    <h4 class="text-center text-primary mb-3">âš¡ Rekap Penagihan ULP Tulung</h4>
    <button id="backBtn" class="btn btn-secondary btn-sm mb-2 d-none">â¬… Kembali</button>
    <div id="view"></div>
</div>

<script>
const { jsPDF } = window.jspdf;
const SHEETS = {
    lembar1: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv"},
    lembar2: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv"},
    lembar3: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv"},
    invoice: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=577428656&single=true&output=csv"),
};

let allData = [], currentDetail = [], currentTitle = "", currentPetugas = "Semua", currentSheet = "lembar1";
let historyStack = [], sortState = { key: null, asc: true };

const parseIDR = (val) => {
    if (!val) return 0;
    let clean = String(val).replace(/[^0-9,-]/g, '').split(',')[0];
    return parseFloat(clean) || 0;
};

const parseDate = (str) => {
    if (!str || str === "-") return new Date(0);
    const parts = str.split('-');
    return new Date(parts[2], parts[1] - 1, parts[0]);
};

const isLunas = r => r.tgl_lunas && r.tgl_lunas.trim() !== "" && r.tgl_lunas !== "-";

function loadSheet(k) {
    currentSheet = k; historyStack = []; currentPetugas = "Semua"; 
    document.querySelectorAll(".nav-link").forEach(t => t.classList.remove("active"));
    document.getElementById("tab-" + k).classList.add("active");
    view.innerHTML = "<p class='text-center'>Memuat data...</p>";
    fetch(SHEETS[k].url).then(r => r.text()).then(csv => {
        allData = Papa.parse(csv, {header: true, skipEmptyLines: true}).data;
        renderPetugas();
    });
}

function pushView(fn) { historyStack.push(fn); backBtn.classList.remove("d-none"); }
backBtn.onclick = () => {
    if (historyStack.length > 0) historyStack.pop()();
    if (historyStack.length === 0) { backBtn.classList.add("d-none"); renderPetugas(); }
};

/* ================= LOGIKA PESAN WHATSAPP & PDF (INVOICE VS TUL) ================= */
const getFullText = (r, type) => {
    const date = new Date();
    const nBulanFull = ["JANUARI", "FEBRUARI", "MARET", "APRIL", "MEI", "JUNI", "JULI", "AGUSTUS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DESEMBER"];
    const blnIniFull = nBulanFull[date.getMonth()];
    const thnIni = date.getFullYear();

    if (currentSheet === 'invoice') {
        // --- PESAN WA UNTUK INVOICE ---
        if (type === 'WA') {
            return encodeURIComponent(
                "*PT. PLN (PERSERO) UID JAWA TENGAH DAN DIY*\n" +
                "*UP3 KLATEN / ULP TULUNG*\n\n" +
                "*PEMBERITAHUAN TAGIHAN LISTRIK*\n" +
                "==========================================\n" +
                "Pelanggan setia PLN,\n" +
                "*Nama* : " + r.nama + "\n" +
                "*Idpel* : " + r.idpel + "\n" +
                "*Alamat* : " + (r.alamat || '-') + "\n" +
                "*Tarif/Daya* : " + r.tarif + "/" + r.daya + "\n" +
                "*Koked* : " + r.koked + "\n\n" +
                "Bersama ini kami sampaikan bahwa Jumlah Total tagihan listrik bulan *" + blnIniFull + " " + thnIni + "* adalah *Rp " + parseIDR(r.jumlah).toLocaleString("id-ID") + "*.\n\n" +
                "Agar terhindar dari pemutusan aliran listrik, kami berharap agar tagihan di atas segera dilunasi. Batas akhir pembayaran adalah tanggal 20 setiap bulannya.\n\n" +
                "Apabila sampai dengan tanggal 20 belum lunas, maka akan dilakukan pemutusan aliran listrik.\n\n" +
                "*BAYARLAH LISTRIK TANGGAL 1-15 SETIAP BULANNYA*\n" +
                "*PASTI NYAMAN SEMUA SENANG*\n\n" +
                "Tulung, " + date.getDate() + " " + blnIniFull + " " + thnIni + "\n" +
                "*MARTONO AJI PRABOWO*\n\n" +
                "_ABAIKAN PEMBERITAHUAN INI JIKA SUDAH MEMBAYAR_"
            );
        }
    } else {
        // --- PESAN WA UNTUK TUNGGAKAN (TUL VI-01) ---
        if (type === 'WA') {
            const body1 = "Dengan ini diberitahukan dengan hormat bahwa pada hari ini aliran listrik terpaksa diputus sementara karena rekening belum dilunasi.";
            return encodeURIComponent(
                "*PT. PLN (PERSERO) ULP TULUNG*\n" +
                "*PEMBERITAHUAN PEMUTUSAN SEMENTARA*\n" +
                "==========================================\n" +
                "*Nama* : " + r.nama + "\n" +
                "*ID Pel* : " + r.idpel + "\n" +
                "*Total Rp* : *" + parseIDR(r.jumlah).toLocaleString("id-ID") + "*\n\n" +
                body1 + "\n\n" +
                "TULUNG, " + date.getDate() + " " + blnIniFull + " " + thnIni + "\n" +
                "*MANAGER*\n*MARTONO AJI PRABOWO*"
            );
        }
    }
    return { tgl: `${date.getDate()} ${blnIniFull} ${thnIni}`, blnIniFull };
};

function createPDF(r) {
    const doc = new jsPDF();
    const info = getFullText(r, 'PDF');
    doc.setFontSize(9);

    if (currentSheet === 'invoice') {
        // --- PDF FORMAT INVOICE ---
        doc.text("PT. PLN (PERSERO) UID JAWA TENGAH DAN DIY", 15, 15);
        doc.text("UP3 KLATEN", 15, 20); doc.text("ULP TULUNG", 15, 25);
        doc.text(`Petugas : ${r.petugas || '-'}`, 150, 20);
        
        doc.setFont(undefined, 'bold'); doc.setFontSize(12);
        doc.text("PEMBERITAHUAN TAGIHAN LISTRIK", 105, 35, {align: "center"});
        
        doc.setFont(undefined, 'normal'); doc.setFontSize(10);
        doc.text("Pelanggan setia PLN,", 15, 45);
        doc.text(`Nama             : ${r.nama}`, 15, 55);
        doc.text(`Idpel              : ${r.idpel}`, 15, 62);
        doc.text(`Alamat           : ${r.alamat || '-'}`, 15, 69);
        doc.text(`Tarif / Daya   : ${r.tarif} / ${r.daya}`, 15, 76);
        doc.text(`Koked : ${r.koked}`, 120, 62);
        doc.text(`No. Kwh : ${r.no_kwh || '-'}`, 120, 76);

        let msg = `Bersama ini kami sampaikan bahwa Jumlah Total tagihan listrik bulan ${info.blnIniFull} adalah Rp ${parseIDR(r.jumlah).toLocaleString("id-ID")}. Agar terhindar dari pemutusan aliran listrik, kami berharap agar tagihan di atas segera dilunasi.`;
        let msgSplit = doc.splitTextToSize(msg, 180);
        doc.text(msgSplit, 15, 88);

        doc.text("Batas akhir pembayaran tagihan listrik adalah tanggal 20 setiap bulannya & hari libur transaksi masih bisa dilakukan pada Loket-loket PPOB online. Apabila sampai dengan tanggal 20 belum lunas, maka akan dilakukan pemutusan aliran listrik.", 15, 105, {maxWidth: 180});
        
        doc.text("Demikian atas perhatian dan kerjasamanya diucapkan terimakasih.", 15, 125);

        doc.setFont(undefined, 'bold');
        doc.text("BAYARLAH LISTRIK TANGGAL 1-15 SETIAP BULANNYA", 15, 145);
        doc.text("PASTI NYAMAN SEMUA SENANG", 15, 150);

        doc.text(`Tulung, ${info.tgl}`, 150, 140);
        doc.text("MARTONO AJI PRABOWO", 150, 165);
        
        doc.setFontSize(8); doc.setFont(undefined, 'italic');
        doc.text("ABAIKAN PEMBERITAHUAN INI JIKA SUDAH MEMBAYAR TAGIHAN", 15, 175);
    } else {
        // --- PDF FORMAT TUL (Sama seperti sebelumnya) ---
        doc.text("PT. PLN (PERSERO) UID JAWA TENGAH DAN DIY", 15, 15);
        doc.setFont(undefined, 'bold'); doc.text("PEMBERITAHUAN PEMUTUSAN SEMENTARA", 105, 30, {align: "center"});
        doc.setFont(undefined, 'normal');
        doc.text(`Nama : ${r.nama}`, 15, 45);
        doc.text(`ID Pel : ${r.idpel}`, 15, 52);
        doc.text(`Total Tagihan : Rp ${parseIDR(r.jumlah).toLocaleString("id-ID")}`, 15, 59);
        doc.text(`Tulung, ${info.tgl}`, 150, 80);
        doc.text("MARTONO AJI PRABOWO", 150, 100);
    }
    doc.save(`Tagihan_${r.idpel}.pdf`);
}

/* ================= ALUR DATA (TETAP SAMA) ================= */
function renderPetugas() {
    const map = {}; let totalRp = 0;
    allData.forEach(r => {
        let pName = r.petugas || "Tanpa Nama";
        map[pName] = map[pName] || {j: 0, rp: 0};
        map[pName].j++; map[pName].rp += parseIDR(r.jumlah); totalRp += parseIDR(r.jumlah);
    });
    const sorted = Object.keys(map).sort().map(p => ({name: p, ...map[p]}));
    let h = `<div class="table-responsive"><table class="table table-bordered"><thead class="table-dark"><tr><th>Petugas</th><th>Jml</th><th>Total Rp</th></tr></thead><tbody><tr class="table-primary clickable" onclick="openGlobal()"><td><b>SEMUA</b></td><td><b>${allData.length}</b></td><td class="text-end"><b>${totalRp.toLocaleString("id-ID")}</b></td></tr>`;
    sorted.forEach(p => { h += `<tr class="clickable" onclick="openPetugas('${p.name}')"><td>${p.name}</td><td>${p.j}</td><td class="text-end">${p.rp.toLocaleString("id-ID")}</td></tr>`; });
    view.innerHTML = h + `</tbody></table></div>`;
}

function openPetugas(p) {
    currentPetugas = p; pushView(renderPetugas);
    const data = allData.filter(r => r.petugas === p);
    const lunas = data.filter(isLunas), belum = data.filter(r => !isLunas(r)), byDate = {};
    lunas.forEach(r => { byDate[r.tgl_lunas] = byDate[r.tgl_lunas] || {j: 0, rp: 0}; byDate[r.tgl_lunas].j++; byDate[r.tgl_lunas].rp += parseIDR(r.jumlah); });
    let h = `<h6 class="text-primary fw-bold">Petugas: ${p}</h6><div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-success"><tr><th>Tanggal</th><th>Plg</th><th>Total Rp</th></tr></thead><tbody>`;
    if (belum.length > 0) h += `<tr class="clickable" onclick="detailBelum()"><td>BELUMLUNAS</td><td>${belum.length}</td><td class="text-end">${belum.reduce((a,b)=>a+parseIDR(b.jumlah),0).toLocaleString("id-ID")}</td></tr>`;
    Object.keys(byDate).sort((a,b) => parseDate(b) - parseDate(a)).forEach(t => { h += `<tr class="clickable" onclick="detailLunas('${t}')"><td>${t}</td><td>${byDate[t].j}</td><td class="text-end">${byDate[t].rp.toLocaleString("id-ID")}</td></tr>`; });
    view.innerHTML = h + `</tbody></table></div>`;
}

function openGlobal() {
    currentPetugas = "Semua"; pushView(renderPetugas);
    const lunas = allData.filter(isLunas), belum = allData.filter(r => !isLunas(r)), byDate = {};
    lunas.forEach(r => { byDate[r.tgl_lunas] = byDate[r.tgl_lunas] || {j: 0, rp: 0}; byDate[r.tgl_lunas].j++; byDate[r.tgl_lunas].rp += parseIDR(r.jumlah); });
    let h = `<h6 class="text-primary fw-bold">Semua Petugas</h6><div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-success"><tr><th>Tanggal</th><th>Plg</th><th>Total Rp</th></tr></thead><tbody>`;
    if (belum.length > 0) h += `<tr class="clickable" onclick="detailBelum()"><td>BELUMLUNAS</td><td>${belum.length}</td><td class="text-end">${belum.reduce((a,b)=>a+parseIDR(b.jumlah),0).toLocaleString("id-ID")}</td></tr>`;
    Object.keys(byDate).sort((a,b) => parseDate(b) - parseDate(a)).forEach(t => { h += `<tr class="clickable" onclick="detailGlobalLunas('${t}')"><td>${t}</td><td>${byDate[t].j}</td><td class="text-end">${byDate[t].rp.toLocaleString("id-ID")}</td></tr>`; });
    view.innerHTML = h + `</tbody></table></div>`;
}

function detailLunas(t) { currentTitle = `Lunas_${t}`; currentDetail = allData.filter(r => r.petugas === currentPetugas && isLunas(r) && r.tgl_lunas === t); pushView(()=>openPetugas(currentPetugas)); renderDetail(); }
function detailBelum() { currentTitle = "Belum_Lunas"; const p = currentPetugas; currentDetail = allData.filter(r => (p === "Semua" ? true : r.petugas === p) && !isLunas(r)); pushView(()=>(p==="Semua"?openGlobal():openPetugas(p))); renderDetail(); }
function detailGlobalLunas(t) { currentTitle = `Global_Lunas_${t}`; currentDetail = allData.filter(r => isLunas(r) && r.tgl_lunas === t); pushView(openGlobal); renderDetail(); }

function renderDetail() {
    sortState = { key: null, asc: true };
    view.innerHTML = `<h6 class="text-center fw-bold small text-uppercase">${currentTitle.replace(/_/g,' ')}</h6><div class="d-flex mb-2 gap-1"><input id="search" class="form-control form-control-sm" placeholder="Cari..."><button class="btn btn-success btn-sm" onclick="exportExcel()">XLSX</button></div><div id="tableArea"></div>`;
    document.getElementById("search").oninput = e => {
        const t = e.target.value.toLowerCase();
        drawTable(currentDetail.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(t))));
    };
    drawTable(currentDetail);
}

function drawTable(data) {
    window.triggerSort = (key) => {
        if (sortState.key === key) sortState.asc = !sortState.asc; else { sortState.key = key; sortState.asc = true; }
        const sorted = [...data].sort((a, b) => {
            let v1 = a[key] || "", v2 = b[key] || "";
            if (key === 'jumlah') return sortState.asc ? parseIDR(v1) - parseIDR(v2) : parseIDR(v2) - parseIDR(v1);
            return sortState.asc ? String(v1).localeCompare(String(v2), undefined, {numeric: true}) : String(v2).localeCompare(String(v1), undefined, {numeric: true});
        });
        drawTable(sorted);
    };
    const icon = (k) => sortState.key === k ? (sortState.asc ? ' â–²' : ' â–¼') : '';
    let h = `<div class="table-responsive"><table class="table table-sm table-bordered" style="font-size:0.7rem"><thead class="table-primary text-nowrap"><tr><th class="clickable" onclick="triggerSort('idpel')">IDPEL${icon('idpel')}</th><th class="clickable" onclick="triggerSort('nama')">Nama${icon('nama')}</th><th class="clickable" onclick="triggerSort('koked')">Koked${icon('koked')}</th><th class="clickable" onclick="triggerSort('jumlah')">Rp${icon('jumlah')}</th></tr></thead><tbody>`;
    data.forEach(r => { h += `<tr class="clickable" onclick="showCardsByData('${r.idpel}')"><td>${r.idpel}</td><td>${r.nama}</td><td>${r.koked}</td><td class="text-end">${parseIDR(r.jumlah).toLocaleString("id-ID")}</td></tr>`; });
    document.getElementById("tableArea").innerHTML = h + `</tbody></table></div>`;
}

function showCardsByData(id) {
    pushView(renderDetail);
    let h = "";
    currentDetail.forEach(r => {
        h += `<div class="card mb-2 ${r.idpel === id?'highlight':''}" id="card-${r.idpel}"><div class="card-body p-2">
            <div class="d-flex justify-content-between"><b>${r.nama}</b> <span class="badge bg-light text-dark">${r.koked}</span></div>
            <p class="text-muted mb-1">${r.idpel} | ${r.tarif}/${r.daya} | ${r.alamat || '-'}</p>
            <div class="d-flex justify-content-between align-items-center">
                <b class="text-danger">Rp ${parseIDR(r.jumlah).toLocaleString("id-ID")}</b>
                <div class="d-flex gap-1">
                    <a class="btn btn-success btn-sm" target="_blank" href="https://wa.me/?text=${getFullText(r, 'WA')}">ðŸ“¤ WA</a>
                    <button class="btn btn-danger btn-sm" onclick='createPDF(${JSON.stringify(r)})'>ðŸ“„ PDF</button>
                </div>
            </div>
        </div></div>`;
    });
    view.innerHTML = h;
    if(id) setTimeout(() => document.getElementById(`card-${id}`).scrollIntoView({behavior:'smooth', block:'center'}), 100);
}

function exportExcel() {
    const ws = XLSX.utils.json_to_sheet(currentDetail), wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Data");
    XLSX.writeFile(wb, `Rekap_${currentTitle}.xlsx`);
}

loadSheet("lembar1");
</script>
</body>
</html>
