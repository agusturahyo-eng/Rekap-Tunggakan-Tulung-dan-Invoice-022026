<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Tunggakan ULP Tulung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{background:#f4f6f9; font-family: sans-serif;}
.clickable{cursor:pointer; user-select: none;}
tr:hover{background:#eef3ff}
.card.highlight { border: 2px solid #0d6efd; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.card-body p { margin-bottom: 2px; line-height: 1.2; font-size: 0.85rem; }
</style>
</head>
<body>
<div class="container my-3">
<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link active" id="tab-lembar1" onclick="loadSheet('lembar1')">Lembar 1</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-lembar2" onclick="loadSheet('lembar2')">Lembar 2</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-lembar3" onclick="loadSheet('lembar3')">Lembar 3</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-invoice" onclick="loadSheet('invoice')">Invoice</a></li>
</ul>
<h4 class="text-center text-primary mb-3">âš¡ Rekap Tunggakan ULP Tulung</h4>
<button id="backBtn" class="btn btn-secondary btn-sm mb-2 d-none">â¬… Kembali</button>
<div id="view"></div>
</div>

<script>
const { jsPDF } = window.jspdf;
const SHEETS = {
  lembar1: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv"},
  lembar2: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv"},
  lembar3: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv"},
  invoice: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=577428656&single=true&output=csv"}
};

let allData = [], currentDetail = [], currentTitle = "", currentPetugas = "Semua", currentSheet = "lembar1";
let historyStack = [], sortState = { key: null, asc: true };

const getVal = (row, keys) => {
    const foundKey = Object.keys(row).find(k => keys.includes(k.toLowerCase().trim().replace(/\s/g, '')));
    return foundKey ? String(row[foundKey]).trim() : "";
};

const parseIDR = (val) => {
  if (!val) return 0;
  let clean = String(val).replace(/[^0-9,-]/g, '').split(',')[0];
  return parseFloat(clean) || 0;
};

const isLunas = r => {
    const val = r.tgl_lunas;
    return val !== "" && val !== "-" && val !== "0" && val.toLowerCase() !== "belum";
};

// FUNGSI TEMPLATE TEKS (PDF & WA SAMA PERSIS)
function buildMessage(r) {
  const date = new Date();
  const blnFull = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
  const tglSkrg = `${date.getDate()} ${blnFull[date.getMonth()]} ${date.getFullYear()}`;
  const rpTotal = parseIDR(r.jumlah).toLocaleString("id-ID");

  if (currentSheet === 'invoice') {
    return `PT. PLN (PERSERO) UID JAWA TENGAH DAN DIY                 Petugas
: ${r.petugas}                                            
UP3 KLATEN                                    
ULP TULUNG
PEMBERITAHUAN TAGIHAN
LISTRIK

Pelanggan setia PLN,
Nama                : ${r.nama}                             GarduTiang : 
Idpel                 : ${r.idpel}                             Koked      : ${r.koked}
Alamat              : ${r.alamat || '-'}
Tarif / Daya      : ${r.tarif}/${r.daya}                            No. Kwh    : ${r.no_kwh}
 
Bersama ini kami sampaikan bahwa Jumlah Total tagihan listrik bulan ${blnFull[date.getMonth()]} ${date.getFullYear()} adalah Rp ${rpTotal}. Agar terhindar dari pemutusan aliran listrik, kami berharap agar tagihan di atas segera dilunasi.
Batas akhir pembayaran tagihan listrik adalah tanggal 20 setiap bulannya & hari libur transaksi masih bisa dilakukan pada Loket-loket PPOB online. Apabila sampai dengan batas waktu yang ditentukan, tanggal 20 belum lunas, maka akan dilakukan pemutusan aliran listrik.
Demikian atas perhatian dan kerjasamanya diucapkan terimakasih.

                                                                  Tulung,
                                                                  ${tglSkrg}

BAYARLAH LISTRIK TANGGAL 1-15 SETIAP BULANNYA
PASTI NYAMAN SEMUA SENANG                                         MARTONO
                                                                  AJI PRABOWO

ABAIKAN PEMBERITAHUAN INI JIKA SUDAH
MEMBAYAR TAGIHAN`;
  } else {
    return `PT. PLN (PERSERO) UID JAWA TENGAH DAN DIY
UP3 KLATEN
ULP TULUNG

PEMBERITAHUAN PELAKSANAAN PEMUTUSAN SEMENTARA
SAMBUNGAN TENAGA LISTRIK
------------------------------------------------------------
Kepada Yth.
Nama          : ${r.nama}
ID. Pelanggan : ${r.idpel}
Alamat        : ${r.alamat || '-'}
Tarip / Daya  : ${r.tarif} / ${r.daya}
Koked         : ${r.koked}

Jumlah Tunggakan : Rp. ${rpTotal}

Dengan ini diberitahukan dengan hormat bahwa pada hari ini aliran listrik di rumah/alamat seperti tersebut diatas terpaksa diputus untuk sementara karena rekening listrik belum dilunasi pada waktu yang telah ditetapkan.

Penyambungan kembali akan dilakukan pada setiap hari jam kerja apabila rekening serta biaya keterlambatan dilunasi di tempat penerimaan pembayaran resmi.

Apabila dalam jangka waktu 60 hari terhitung sejak dilakukan pemutusan sementara tunggakan belum dilunasi, maka instalasi milik PLN akan dibongkar.

UNTUK MENGHINDARI RESIKO, MOHON TIDAK TITIP PEMBAYARAN REKENING KEPADA PETUGAS

Tulung, ${tglSkrg}
MANAGER

MARTONO AJI PRABOWO`;
  }
}

function createPDF(r) {
  const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: [139.7, 215.9] });
  doc.setFont("courier", "bold"); doc.setFontSize(8.5);
  const text = buildMessage(r);
  const splitText = doc.splitTextToSize(text, 125);
  doc.text(splitText, 10, 15);
  doc.save(`${currentSheet.toUpperCase()}_${r.idpel}.pdf`);
}

function loadSheet(k) {
  currentSheet = k; historyStack = [];
  document.querySelectorAll(".nav-link").forEach(t => t.classList.remove("active"));
  document.getElementById("tab-" + k).classList.add("active");
  view.innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-primary"></div></div>';
  fetch(SHEETS[k].url + "&t=" + new Date().getTime()).then(r => r.text()).then(csv => {
    allData = Papa.parse(csv, {header: true, skipEmptyLines: true}).data.map(r => ({
        idpel: getVal(r, ['idpel', 'idpelanggan']),
        nama: getVal(r, ['nama', 'namapelanggan']),
        tarif: getVal(r, ['tarif', 'trf']),
        daya: getVal(r, ['daya', 'dy']),
        rptag: getVal(r, ['rptag', 'tagihan', 'rp tag']),
        rpbk: getVal(r, ['rpbk', 'bk', 'rp bk']),
        jumlah: getVal(r, ['jumlah', 'total', 'rp']),
        petugas: getVal(r, ['petugas', 'ptgs']) || "Tanpa Nama",
        alamat: getVal(r, ['alamat', 'almt']),
        koked: getVal(r, ['koked', 'kdkd']),
        tgl_lunas: getVal(r, ['tgllunas', 'lunas', 'tgl_lunas']),
        no_kwh: getVal(r, ['nokwh', 'no_kwh']) || "-"
    }));
    renderPetugas();
  });
}

function pushView(fn) { historyStack.push(fn); backBtn.classList.remove("d-none"); }
backBtn.onclick = () => { if (historyStack.length > 0) historyStack.pop()(); if (historyStack.length === 0) { backBtn.classList.add("d-none"); renderPetugas(); } };

function renderPetugas() {
  const map = {}; let totalRp = 0; allData.forEach(r => { let pName = r.petugas; map[pName] = (map[pName] || 0) + parseIDR(r.jumlah); totalRp += parseIDR(r.jumlah); });
  let h = `<table class="table table-bordered"><thead class="table-dark"><tr><th>Petugas</th><th>Rp Total</th></tr></thead><tbody><tr class="table-primary clickable" onclick="openGlobal()"><td><b>SEMUA</b></td><td class="text-end"><b>${totalRp.toLocaleString("id-ID")}</b></td></tr>`;
  Object.keys(map).sort().forEach(p => { h += `<tr class="clickable" onclick="openPetugas('${p}')"><td>${p}</td><td class="text-end">${map[p].toLocaleString("id-ID")}</td></tr>`; });
  view.innerHTML = h + `</tbody></table>`;
}

function openPetugas(p) {
  currentPetugas = p; pushView(renderPetugas);
  const belum = allData.filter(r => r.petugas === p && !isLunas(r));
  view.innerHTML = `<h6>Petugas: ${p}</h6><button class="btn btn-outline-danger w-100 mb-2" onclick="detailBelum()">Lihat Belum Lunas (${belum.length})</button>`;
}

function openGlobal() {
  currentPetugas = "Semua"; pushView(renderPetugas);
  const belum = allData.filter(r => !isLunas(r));
  view.innerHTML = `<h6>Semua Petugas</h6><button class="btn btn-outline-danger w-100 mb-2" onclick="detailBelum()">Lihat Semua Belum Lunas (${belum.length})</button>`;
}

function detailBelum() {
  currentTitle = "Belum Lunas";
  currentDetail = allData.filter(r => (currentPetugas === "Semua" ? true : r.petugas === currentPetugas) && !isLunas(r));
  pushView(() => (currentPetugas === "Semua" ? openGlobal() : openPetugas(currentPetugas)));
  renderDetail();
}

function renderDetail() {
  view.innerHTML = `<input id="search" class="form-control mb-2" placeholder="Cari Nama/Idpel..."><div id="tableArea"></div>`;
  document.getElementById("search").oninput = e => drawTable(currentDetail.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(e.target.value.toLowerCase()))));
  drawTable(currentDetail);
}

function drawTable(data) {
  let h = `<div class="table-responsive"><table class="table table-sm table-bordered" style="font-size:0.8rem"><thead><tr class="table-secondary"><th>Nama</th><th>IDPEL</th><th>Aksi</th></tr></thead><tbody>`;
  data.forEach(r => {
    h += `<tr><td>${r.nama}</td><td>${r.idpel}</td><td><button class="btn btn-primary btn-sm" onclick='showAction("${r.idpel}")'>Buka</button></td></tr>`;
  });
  document.getElementById("tableArea").innerHTML = h + `</tbody></table></div>`;
}

function showAction(id) {
  const r = allData.find(x => x.idpel === id);
  pushView(renderDetail);
  view.innerHTML = `<div class="card"><div class="card-body"><h5>${r.nama}</h5><p>${r.idpel}</p><p class="fw-bold text-danger">Total: Rp ${parseIDR(r.jumlah).toLocaleString("id-ID")}</p><hr>
  <button class="btn btn-success w-100 mb-2" onclick="window.open('https://wa.me/?text='+encodeURIComponent(buildMessage(allData.find(x=>x.idpel=='${id}'))))">ðŸ“¤ Kirim WA</button>
  <button class="btn btn-danger w-100" onclick='createPDF(allData.find(x=>x.idpel=="${id}"))'>ðŸ“„ Download PDF</button></div></div>`;
}

loadSheet("lembar1");
</script>
</body>
</html>
