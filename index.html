<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Rekap Tunggakan ULP Tulung</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body{background:#f4f6f9; font-family: sans-serif;}
        .clickable{cursor:pointer; user-select: none;}
        tr:hover{background:#eef3ff}
        .card.highlight { border: 2px solid #0d6efd; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .card-body p { margin-bottom: 2px; line-height: 1.2; font-size: 0.85rem; }
    </style>
</head>
<body>
<div class="container my-3">
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item"><a class="nav-link active" id="tab-lembar1" onclick="loadSheet('lembar1')">Lembar 1</a></li>
        <li class="nav-item"><a class="nav-link" id="tab-lembar2" onclick="loadSheet('lembar2')">Lembar 2</a></li>
        <li class="nav-item"><a class="nav-link" id="tab-lembar3" onclick="loadSheet('lembar3')">Lembar 3</a></li>
        <li class="nav-item"><a class="nav-link" id="tab-invoice" onclick="loadSheet('invoice')">Invoice</a></li>
    </ul>
    <h4 class="text-center text-primary mb-3">⚡ Rekap Tunggakan ULP Tulung</h4>
    <button id="backBtn" class="btn btn-secondary btn-sm mb-2 d-none">⬅ Kembali</button>
    <div id="view"></div>
</div>

<script>
const { jsPDF } = window.jspdf;
const SHEETS = {
    lembar1: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv"},
    lembar2: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv"},
    lembar3: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv"},
    invoice: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=577428656&single=true&output=csv"}
};

let allData = [], currentDetail = [], currentTitle = "", currentPetugas = "Semua", currentSheet = "lembar1";
let historyStack = [], sortState = { key: null, asc: true };

const getVal = (row, keys) => {
    const foundKey = Object.keys(row).find(k => keys.includes(k.toLowerCase().trim().replace(/\s/g, '')));
    return foundKey ? String(row[foundKey]).trim() : "";
};

const parseIDR = (val) => {
    if (!val) return 0;
    let clean = String(val).replace(/[^0-9]/g, '');
    return parseFloat(clean) || 0;
};

const isLunas = r => r.tgl_lunas && r.tgl_lunas !== "" && r.tgl_lunas.toLowerCase() !== "belum";

// FUNGSI INI ADALAH KUNCI AGAR WA DAN PDF SAMA PERSIS
function buildMasterText(r) {
    const date = new Date();
    const tglSkrg = `${date.getDate()} Januari 2026`; // Sesuai permintaan Bapak
    const rpTotal = parseIDR(r.jumlah).toLocaleString("id-ID");

    if (currentSheet === 'invoice') {
        return `PT. PLN (PERSERO) UID JAWA TENGAH DAN DIY                 Petugas
: ${r.petugas}                                            
UP3 KLATEN                                    
ULP TULUNG
PEMBERITAHUAN TAGIHAN
LISTRIK
Pelanggan setia PLN,
Nama                : ${r.nama}                             GarduTiang : 
Idpel                 : ${r.idpel}                             Koked      : ${r.koked}
Alamat              : ${r.alamat || '-'}
Tarif / Daya      : ${r.tarif}/${r.daya}                            No. Kwh    : ${r.no_kwh}
 
Bersama ini kami sampaikan bahwa
Jumlah Total tagihan listrik bulan Januari 2026 adalah Rp ${rpTotal}. Agar terhindar dari pemutusan aliran listrik, kami berharap agar tagihan di atas segera dilunasi.
Batas akhir pembayaran tagihan listrik adalah tanggal 20 setiap bulannya & hari libur
transaksi masih bisa dilakukan pada Loket-loket PPOB online. Apabila sampai dengan batas waktu yang ditentukan,
tanggal 20 belum lunas, maka akan dilakukan pemutusan aliran listrik
Demikian atas perhatian dan kerjasamanya diucapkan terimakasih.
                                                                  Tulung,
                                                                  ${tglSkrg}

BAYARLAH LISTRIK TANGGAL 1-15 SETIAP BULANNYA
PASTI NYAMAN SEMUA SENANG                                         MARTONO
                                                                  AJI PRABOWO

ABAIKAN PEMBERITAHUAN INI JIKA SUDAH
MEMBAYAR TAGIHAN`;
    } else {
        return `PT. PLN (PERSERO) UID JAWA TENGAH DAN DIY
UP3 KLATEN
ULP TULUNG

PEMBERITAHUAN PELAKSANAAN PEMUTUSAN SEMENTARA
SAMBUNGAN TENAGA LISTRIK
------------------------------------------------------------
Kepada Yth.
Nama          : ${r.nama}
ID. Pelanggan : ${r.idpel}
Alamat        : ${r.alamat || '-'}
Tarip / Daya  : ${r.tarif} / ${r.daya}
Koked         : ${r.koked}

Jumlah Tunggakan : Rp. ${rpTotal}

Dengan ini diberitahukan dengan hormat bahwa pada hari ini aliran listrik di rumah/alamat seperti tersebut diatas terpaksa diputus untuk sementara karena rekening listrik belum dilunasi pada waktu yang telah ditetapkan.

Penyambungan kembali akan dilakukan pada setiap hari jam kerja apabila rekening serta biaya keterlambatan dilunasi di tempat penerimaan pembayaran resmi.

Tulung, ${tglSkrg}
MANAGER

MARTONO AJI PRABOWO`;
    }
}

function loadSheet(k) {
    currentSheet = k; historyStack = [];
    document.querySelectorAll(".nav-link").forEach(t => t.classList.remove("active"));
    document.getElementById("tab-" + k).classList.add("active");
    view.innerHTML = "Memuat data...";
    fetch(SHEETS[k].url + "&t=" + new Date().getTime()).then(res => res.text()).then(csv => {
        allData = Papa.parse(csv, {header: true, skipEmptyLines: true}).data.map(r => ({
            idpel: getVal(r, ['idpel', 'idpelanggan']),
            nama: getVal(r, ['nama', 'namapelanggan']),
            tarif: getVal(r, ['tarif', 'trf']),
            daya: getVal(r, ['daya', 'dy']),
            jumlah: getVal(r, ['jumlah', 'total', 'rp']),
            petugas: getVal(r, ['petugas', 'ptgs']) || "Petugas",
            alamat: getVal(r, ['alamat', 'almt']),
            koked: getVal(r, ['koked', 'kdkd']),
            tgl_lunas: getVal(r, ['tgllunas', 'lunas', 'tgl_lunas']),
            no_kwh: getVal(r, ['nokwh', 'no_kwh']) || "-"
        }));
        renderPetugas();
    });
}

function pushView(fn) { historyStack.push(fn); backBtn.classList.remove("d-none"); }
backBtn.onclick = () => { if (historyStack.length > 0) historyStack.pop()(); if (historyStack.length === 0) backBtn.classList.add("d-none"); };

function renderPetugas() {
    const map = {}; allData.forEach(r => { map[r.petugas] = (map[r.petugas] || 0) + parseIDR(r.jumlah); });
    let h = `<table class="table table-bordered mt-2"><thead class="table-dark"><tr><th>Petugas</th><th>Total Tagihan</th></tr></thead><tbody>`;
    Object.keys(map).sort().forEach(p => { h += `<tr class="clickable" onclick="openPetugas('${p}')"><td>${p}</td><td class="text-end">${map[p].toLocaleString("id-ID")}</td></tr>`; });
    view.innerHTML = h + `</tbody></table>`;
}

function openPetugas(p) {
    currentPetugas = p; pushView(renderPetugas);
    const filtered = allData.filter(r => r.petugas === p && !isLunas(r));
    view.innerHTML = `<h5>Petugas: ${p}</h5><input id="search" class="form-control mb-2" placeholder="Cari Nama/Idpel..."><div id="listArea"></div>`;
    document.getElementById("search").oninput = (e) => {
        const t = e.target.value.toLowerCase();
        drawList(filtered.filter(r => r.nama.toLowerCase().includes(t) || r.idpel.includes(t)));
    };
    drawList(filtered);
}

function drawList(data) {
    let h = "";
    data.forEach(r => {
        h += `<div class="card mb-2 shadow-sm"><div class="card-body">
            <b>${r.nama}</b><br><small>${r.idpel}</small><br><b>Rp ${parseIDR(r.jumlah).toLocaleString("id-ID")}</b>
            <div class="mt-2 d-flex gap-2">
                <button class="btn btn-success btn-sm w-100" onclick="window.open('https://wa.me/?text='+encodeURIComponent(buildMasterText(allData.find(x=>x.idpel=='${r.idpel}'))))">WA</button>
                <button class="btn btn-danger btn-sm w-100" onclick='createPDF("${r.idpel}")'>PDF</button>
            </div>
        </div></div>`;
    });
    document.getElementById("listArea").innerHTML = h;
}

function createPDF(idpel) {
    const r = allData.find(x => x.idpel === idpel);
    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: [139.7, 215.9] });
    doc.setFont("courier", "bold"); doc.setFontSize(8.5);
    const splitText = doc.splitTextToSize(buildMasterText(r), 125);
    doc.text(splitText, 10, 15);
    doc.save(`${idpel}.pdf`);
}

loadSheet("lembar1");
</script>
</body>
</html>
