<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Tunggakan ULP Tulung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body{background:#f4f6f9; font-family: sans-serif; font-size: 14px;}
    .clickable{cursor:pointer; user-select: none;}
    tr:hover{background:#eef3ff}
    .card.highlight { border: 2px solid #0d6efd; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .card-body p { margin-bottom: 2px; line-height: 1.2; font-size: 0.85rem; }
    .nav-tabs .nav-link { color: #495057; font-weight: bold; }
    .nav-tabs .nav-link.active { color: #0d6efd; }
</style>
</head>
<body>
<div class="container my-3">
    <ul class="nav nav-tabs mb-3" id="mainTab">
        <li class="nav-item"><a class="nav-link active" id="tab-lembar1" onclick="loadSheet('lembar1')">Lembar 1</a></li>
        <li class="nav-item"><a class="nav-link" id="tab-lembar2" onclick="loadSheet('lembar2')">Lembar 2</a></li>
        <li class="nav-item"><a class="nav-link" id="tab-lembar3" onclick="loadSheet('lembar3')">Lembar 3</a></li>
        <li class="nav-item"><a class="nav-link" id="tab-invoice" onclick="loadSheet('invoice')">Invoice</a></li>
    </ul>
    
    <h4 class="text-center text-primary mb-3">âš¡ Rekap Tunggakan ULP Tulung</h4>
    <div class="d-flex justify-content-between mb-2">
        <button id="backBtn" class="btn btn-secondary btn-sm d-none">â¬… Kembali</button>
    </div>
    <div id="view"></div>
</div>

<script>
const { jsPDF } = window.jspdf;
const SHEETS = {
    lembar1: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv"},
    lembar2: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv"},
    lembar3: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv"},
    invoice: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=577428656&single=true&output=csv"}
};

let allData = [], currentPetugas = "Semua", currentSheet = "lembar1", historyStack = [];

const getVal = (row, keys) => {
    const foundKey = Object.keys(row).find(k => keys.includes(k.toLowerCase().trim().replace(/\s/g, '')));
    return foundKey ? String(row[foundKey]).trim() : "";
};

const parseIDR = (val) => {
    if (!val) return 0;
    let clean = String(val).replace(/[^0-9]/g, '');
    return parseFloat(clean) || 0;
};

const isLunas = r => r.tgl_lunas && r.tgl_lunas !== "" && r.tgl_lunas !== "-" && r.tgl_lunas.toLowerCase() !== "belum";

// FUNGSI TEKS SAMA PERSIS (UNTUK WA & PDF)
function getFormatTeks(r) {
    const date = new Date();
    const blnFull = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const tglSkrg = `${date.getDate()} ${blnFull[date.getMonth()]} ${date.getFullYear()}`;
    const rpTotal = parseIDR(r.jumlah).toLocaleString("id-ID");

    if (currentSheet === 'invoice') {
        return `PT. PLN (PERSERO) UID JAWA TENGAH DAN DIY                 Petugas\n: ${r.petugas}                                            \nUP3 KLATEN                                    \nULP TULUNG\nPEMBERITAHUAN TAGIHAN\nLISTRIK\n\nPelanggan setia PLN,\nNama                : ${r.nama}                             GarduTiang : \nIdpel                 : ${r.idpel}                             Koked      : ${r.koked}\nAlamat              : ${r.alamat || '-'}\nTarif / Daya      : ${r.tarif}/${r.daya}                            No. Kwh    : ${r.no_kwh}\n \nBersama ini kami sampaikan bahwa Jumlah Total tagihan listrik bulan ${blnFull[date.getMonth()]} ${date.getFullYear()} adalah Rp ${rpTotal}. Agar terhindar dari pemutusan aliran listrik, kami berharap agar tagihan di atas segera dilunasi.\nBatas akhir pembayaran tagihan listrik adalah tanggal 20 setiap bulannya & hari libur transaksi masih bisa dilakukan pada Loket-loket PPOB online. Apabila sampai dengan batas waktu yang ditentukan, tanggal 20 belum lunas, maka akan dilakukan pemutusan aliran listrik.\nDemikian atas perhatian dan kerjasamanya diucapkan terimakasih.\n\n                                                                  Tulung,\n                                                                  ${tglSkrg}\n\nBAYARLAH LISTRIK TANGGAL 1-15 SETIAP BULANNYA\nPASTI NYAMAN SEMUA SENANG                                         MARTONO\n                                                                  AJI PRABOWO\n\nABAIKAN PEMBERITAHUAN INI JIKA SUDAH\nMEMBAYAR TAGIHAN`;
    } else {
        return `PT. PLN (PERSERO) UID JAWA TENGAH DAN DIY\nUP3 KLATEN\nULP TULUNG\n\nPEMBERITAHUAN PELAKSANAAN PEMUTUSAN SEMENTARA\nSAMBUNGAN TENAGA LISTRIK\n------------------------------------------------------------\nKepada Yth.\nNama          : ${r.nama}\nID. Pelanggan : ${r.idpel}\nAlamat        : ${r.alamat || '-'}\nTarip / Daya  : ${r.tarif} / ${r.daya}\nKoked         : ${r.koked}\n\nJumlah Tunggakan : Rp. ${rpTotal}\n\nDengan ini diberitahukan dengan hormat bahwa pada hari ini aliran listrik di rumah/alamat seperti tersebut diatas terpaksa diputus untuk sementara karena rekening listrik belum dilunasi pada waktu yang telah ditetapkan.\n\nPenyambungan kembali akan dilakukan pada setiap hari jam kerja apabila rekening serta biaya keterlambatan dilunasi di tempat penerimaan pembayaran resmi.\n\nApabila dalam jangka waktu 60 hari terhitung sejak dilakukan pemutusan sementara tunggakan belum dilunasi, maka instalasi milik PLN akan dibongkar.\n\nUNTUK MENGHINDARI RESIKO, MOHON TIDAK TITIP PEMBAYARAN REKENING KEPADA PETUGAS\n\nTulung, ${tglSkrg}\nMANAGER\n\nMARTONO AJI PRABOWO`;
    }
}

function createPDF(idpel) {
    const r = allData.find(x => x.idpel === idpel);
    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: [139.7, 215.9] });
    doc.setFont("courier", "bold");
    doc.setFontSize(8.5);
    const splitText = doc.splitTextToSize(getFormatTeks(r), 125);
    doc.text(splitText, 10, 15);
    doc.save(`${currentSheet.toUpperCase()}_${idpel}.pdf`);
}

function sendWA(idpel) {
    const r = allData.find(x => x.idpel === idpel);
    const msg = encodeURIComponent(getFormatTeks(r));
    window.open(`https://wa.me/?text=${msg}`, '_blank');
}

// LOGIKA DASHBOARD (VERSI STABIL)
function loadSheet(k) {
    currentSheet = k; historyStack = [];
    document.querySelectorAll(".nav-link").forEach(t => t.classList.remove("active"));
    document.getElementById("tab-" + k).classList.add("active");
    document.getElementById("view").innerHTML = "Memuat data...";
    fetch(SHEETS[k].url + "&t=" + new Date().getTime()).then(res => res.text()).then(csv => {
        allData = Papa.parse(csv, {header: true, skipEmptyLines: true}).data.map(r => ({
            idpel: getVal(r, ['idpel', 'idpelanggan']),
            nama: getVal(r, ['nama', 'namapelanggan']),
            tarif: getVal(r, ['tarif', 'trf']),
            daya: getVal(r, ['daya', 'dy']),
            jumlah: getVal(r, ['jumlah', 'total', 'rp']),
            petugas: getVal(r, ['petugas', 'ptgs']) || "Tanpa Nama",
            alamat: getVal(r, ['alamat', 'almt']),
            koked: getVal(r, ['koked', 'kdkd']),
            tgl_lunas: getVal(r, ['tgllunas', 'lunas', 'tgl_lunas']),
            no_kwh: getVal(r, ['nokwh', 'no_kwh']) || "-"
        }));
        renderPetugas();
    });
}

function pushView(fn) { historyStack.push(fn); document.getElementById("backBtn").classList.remove("d-none"); }
document.getElementById("backBtn").onclick = () => { if (historyStack.length > 0) historyStack.pop()(); if (historyStack.length === 0) document.getElementById("backBtn").classList.add("d-none"); };

function renderPetugas() {
    const map = {}; allData.forEach(r => { map[r.petugas] = (map[r.petugas] || 0) + parseIDR(r.jumlah); });
    let h = `<table class="table table-bordered"><thead><tr class="table-dark"><th>Petugas</th><th>Total Tagihan</th></tr></thead><tbody>`;
    Object.keys(map).sort().forEach(p => { h += `<tr class="clickable" onclick="openPetugas('${p}')"><td>${p}</td><td class="text-end">${map[p].toLocaleString("id-ID")}</td></tr>`; });
    document.getElementById("view").innerHTML = h + `</tbody></table>`;
}

function openPetugas(p) {
    currentPetugas = p; pushView(renderPetugas);
    const filtered = allData.filter(r => r.petugas === p && !isLunas(r));
    document.getElementById("view").innerHTML = `<h5>Petugas: ${p}</h5><input id="search" class="form-control mb-2" placeholder="Cari Nama/Idpel..."><div id="listArea"></div>`;
    document.getElementById("search").oninput = (e) => renderList(filtered.filter(r => r.nama.toLowerCase().includes(e.target.value.toLowerCase()) || r.idpel.includes(e.target.value)));
    renderList(filtered);
}

function renderList(data) {
    let h = "";
    data.forEach(r => {
        h += `<div class="card mb-2 shadow-sm"><div class="card-body">
            <div class="d-flex justify-content-between"><b>${r.nama}</b> <span class="badge bg-info text-dark">${r.koked}</span></div>
            <p class="text-muted small">${r.idpel} | ${r.tarif}/${r.daya}</p>
            <p class="text-danger fw-bold">Rp ${parseIDR(r.jumlah).toLocaleString("id-ID")}</p>
            <div class="d-flex gap-2 mt-2">
                <button class="btn btn-success btn-sm w-100" onclick="sendWA('${r.idpel}')">ðŸ“¤ WA</button>
                <button class="btn btn-danger btn-sm w-100" onclick="createPDF('${r.idpel}')">ðŸ“„ PDF</button>
            </div>
        </div></div>`;
    });
    document.getElementById("listArea").innerHTML = h;
}

loadSheet("lembar1");
</script>
</body>
</html>
