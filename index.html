<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Tunggakan ULP Tulung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{background:#f4f6f9; font-family: sans-serif; font-size: 0.9rem;}
.clickable{cursor:pointer; user-select: none;}
tr:hover{background:#eef3ff}
.table-primary th { background-color: #0d6efd !important; color: white; border: none; }
.card.highlight { border: 2px solid #0d6efd; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.card-body p { margin-bottom: 2px; line-height: 1.2; font-size: 0.85rem; }
.nav-link { cursor: pointer; font-weight: bold; color: #555; }
.nav-link.active { color: #0d6efd !important; border-bottom: 3px solid #0d6efd !important; }
</style>
</head>
<body>
<div class="container my-3">
<ul class="nav nav-tabs mb-3" id="tabMenu">
  <li class="nav-item"><a class="nav-link active" id="tab-lembar1" onclick="loadSheet('lembar1')">Lembar 1</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-lembar2" onclick="loadSheet('lembar2')">Lembar 2</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-lembar3" onclick="loadSheet('lembar3')">Lembar 3</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-invoice" onclick="loadSheet('invoice')">Invoice</a></li>
</ul>
<h4 class="text-center text-primary mb-3">âš¡ Rekap Tunggakan ULP Tulung</h4>
<div class="d-flex justify-content-between mb-2">
    <button id="backBtn" class="btn btn-secondary btn-sm d-none">â¬… Kembali</button>
    <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">ðŸ”„ Refresh</button>
</div>
<div id="view"></div>
</div>

<script>
const { jsPDF } = window.jspdf;

// URL Google Sheets Bapak
const SHEETS = {
  lembar1: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv",
  lembar2: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv",
  lembar3: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv",
  invoice: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=577428656&single=true&output=csv"
};

let allData = [], currentDetail = [], currentTitle = "", currentPetugas = "Semua", currentSheet = "lembar1";
let historyStack = [];

function loadSheet(k) {
  currentSheet = k; historyStack = []; 
  document.querySelectorAll(".nav-link").forEach(t => t.classList.remove("active"));
  document.getElementById("tab-" + k).classList.add("active");
  view.innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-primary"></div><p>Memuat data...</p></div>';

  fetch(SHEETS[k] + "&t=" + new Date().getTime())
    .then(res => res.text())
    .then(csv => {
      // Kita baca mentah tanpa melihat Nama Header
      const parsed = Papa.parse(csv, {skipEmptyLines: true}).data;
      const rows = parsed.slice(1); // Mulai dari baris ke-2 (Data)

      allData = rows.map(cols => ({
        idpel: (cols[0] || "").trim(),     // Kolom A
        nama: (cols[1] || "").trim(),      // Kolom B
        tarif: (cols[2] || "").trim(),     // Kolom C
        daya: (cols[3] || "").trim(),      // Kolom D
        rptag: cols[4] || "0",             // Kolom E
        rpbk: cols[5] || "0",              // Kolom F
        jumlah: cols[6] || "0",            // Kolom G
        petugas: (cols[7] || "Tanpa Nama").trim(), // Kolom H
        alamat: (cols[9] || "-").trim(),   // Kolom J
        koked: (cols[10] || "-").trim(),   // Kolom K
        tgl_lunas: (cols[11] || "").trim() // Kolom L
      }));
      renderPetugas();
    });
}

const parseIDR = (v) => {
  if (!v) return 0;
  let clean = String(v).replace(/[^0-9]/g, '');
  return parseFloat(clean) || 0;
};

const isLunas = r => r.tgl_lunas !== "" && r.tgl_lunas !== "-" && r.tgl_lunas !== "0";

// Narasi WA & PDF
const getFullText = (r, type) => {
  const d = new Date();
  const nBulanFull = ["JANUARI", "FEBRUARI", "MARET", "APRIL", "MEI", "JUNI", "JULI", "AGUSTUS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DESEMBER"];
  const txt = `PEMBERITAHUAN PEMUTUSAN SEMENTARA\nNama: ${r.nama}\nIDPEL: ${r.idpel}\nTarif/Daya: ${r.tarif}/${r.daya}\nAlamat: ${r.alamat}\nTotal Tunggakan: Rp ${parseIDR(r.jumlah).toLocaleString("id-ID")}\n\nSegera lakukan pelunasan agar aliran listrik tidak diputus.`;
  return type === 'WA' ? encodeURIComponent(`*PT. PLN (PERSERO) ULP TULUNG*\n\n*${txt}*`) : {txt, tgl: `${d.getDate()} ${nBulanFull[d.getMonth()]} ${d.getFullYear()}`};
};

function createPDF(r) {
  const doc = new jsPDF(); const info = getFullText(r, 'PDF');
  doc.setFontSize(10); doc.text("PT. PLN (PERSERO) ULP TULUNG", 15, 15);
  doc.setFont(undefined, 'bold'); doc.text(info.txt, 15, 30);
  doc.save(`TUL_${r.idpel}.pdf`);
}

function renderPetugas() {
  const map = {}; let totalAll = 0;
  allData.forEach(r => {
    let p = r.petugas;
    map[p] = map[p] || {j: 0, rp: 0};
    map[p].j++; map[p].rp += parseIDR(r.jumlah); totalAll += parseIDR(r.jumlah);
  });
  const sorted = Object.keys(map).sort().map(p => ({name: p, ...map[p]}));
  let h = `<div class="table-responsive"><table class="table table-bordered shadow-sm"><thead class="table-dark"><tr><th>Petugas</th><th>Jml</th><th class="text-end">Total Rp</th></tr></thead><tbody><tr class="table-primary clickable fw-bold" onclick="openGlobal()"><td>SEMUA PETUGAS</td><td>${allData.length}</td><td class="text-end">${totalAll.toLocaleString("id-ID")}</td></tr>`;
  sorted.forEach(p => { h += `<tr class="clickable" onclick="openPetugas('${p.name}')"><td>${p.name}</td><td>${p.j}</td><td class="text-end">${p.rp.toLocaleString("id-ID")}</td></tr>`; });
  view.innerHTML = h + `</tbody></table></div>`;
}

function openPetugas(p) {
  currentPetugas = p; pushView(renderPetugas);
  const data = allData.filter(r => r.petugas === p);
  const lunas = data.filter(isLunas), belum = data.filter(r => !isLunas(r));
  view.innerHTML = `<h6 class="fw-bold">Petugas: ${p}</h6><div class="list-group shadow-sm"><button class="list-group-item list-group-item-action d-flex justify-content-between text-danger fw-bold" onclick="detailBelum()"><span>BELUM LUNAS</span><span>${belum.length} Plg</span></button><button class="list-group-item list-group-item-action d-flex justify-content-between text-success fw-bold" onclick="detailLunasGlobal()"><span>SUDAH LUNAS</span><span>${lunas.length} Plg</span></button></div>`;
}

function openGlobal() {
  currentPetugas = "Semua"; pushView(renderPetugas);
  const lunas = allData.filter(isLunas), belum = allData.filter(r => !isLunas(r));
  view.innerHTML = `<h6 class="fw-bold">Global ULP Tulung</h6><div class="list-group shadow-sm"><button class="list-group-item list-group-item-action d-flex justify-content-between text-danger fw-bold" onclick="detailBelum()"><span>BELUM LUNAS</span><span>${belum.length} Plg</span></button><button class="list-group-item list-group-item-action d-flex justify-content-between text-success fw-bold" onclick="detailLunasGlobal()"><span>SUDAH LUNAS</span><span>${lunas.length} Plg</span></button></div>`;
}

function detailBelum() { 
  currentTitle = "BELUM LUNAS";
  currentDetail = allData.filter(r => (currentPetugas === "Semua" ? true : r.petugas === currentPetugas) && !isLunas(r));
  pushView(() => currentPetugas === "Semua" ? openGlobal() : openPetugas(currentPetugas));
  renderTable(); 
}

function detailLunasGlobal() {
  currentTitle = "SUDAH LUNAS";
  currentDetail = allData.filter(r => (currentPetugas === "Semua" ? true : r.petugas === currentPetugas) && isLunas(r));
  pushView(() => currentPetugas === "Semua" ? openGlobal() : openPetugas(currentPetugas));
  renderTable();
}

function renderTable() {
  view.innerHTML = `<h6 class="text-center fw-bold mb-2">${currentTitle}</h6><input id="search" class="form-control form-control-sm mb-2" placeholder="Cari Nama/IDPEL..."><div id="listArea"></div>`;
  document.getElementById("search").oninput = e => drawList(currentDetail.filter(r => r.nama.toLowerCase().includes(e.target.value.toLowerCase()) || r.idpel.includes(e.target.value)));
  drawList(currentDetail);
}

function drawList(data) {
  let h = "";
  data.forEach(r => {
    h += `<div class="card mb-2 shadow-sm"><div class="card-body p-2">
      <div class="d-flex justify-content-between"><b>${r.nama}</b> <small>${r.koked}</small></div>
      <p class="text-muted small mb-1">${r.idpel} | ${r.tarif}/${r.daya}</p>
      <div class="d-flex justify-content-between align-items-center">
        <b class="text-danger">Rp ${parseIDR(r.jumlah).toLocaleString("id-ID")}</b>
        <div class="d-flex gap-1">
          <a class="btn btn-success btn-sm" target="_blank" href="https://wa.me/?text=${getFullText(r, 'WA')}">WA</a>
          <button class="btn btn-danger btn-sm" onclick='createPDF(${JSON.stringify(r)})'>PDF</button>
        </div>
      </div>
    </div></div>`;
  });
  document.getElementById("listArea").innerHTML = h;
}

function pushView(fn) { historyStack.push(fn); document.getElementById("backBtn").classList.remove("d-none"); }
document.getElementById("backBtn").onclick = () => {
  if (historyStack.length > 0) historyStack.pop()();
  if (historyStack.length === 0) document.getElementById("backBtn").classList.add("d-none");
};

loadSheet("lembar1");
</script>
</body>
</html>
