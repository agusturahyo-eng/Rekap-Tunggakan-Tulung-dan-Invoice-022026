<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Tunggakan & Invoice ULP Tulung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{background:#f4f6f9; font-family: sans-serif;}
.clickable{cursor:pointer; user-select: none;}
tr:hover{background:#eef3ff}
.table-primary th:hover { background-color: #0d6efd !important; color: white; }
.card.highlight { border: 2px solid #0d6efd; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.card-body p { margin-bottom: 2px; line-height: 1.2; font-size: 0.85rem; }
</style>
</head>
<body>
<div class="container my-3">
<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link active" id="tab-lembar1" onclick="loadSheet('lembar1')">Lembar 1</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-lembar2" onclick="loadSheet('lembar2')">Lembar 2</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-lembar3" onclick="loadSheet('lembar3')">Lembar 3</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-invoice" onclick="loadSheet('invoice')">Invoice</a></li>
</ul>
<h4 class="text-center text-primary mb-3">âš¡ Rekap Tunggakan & Invoice ULP Tulung</h4>
<button id="backBtn" class="btn btn-secondary btn-sm mb-2 d-none">â¬… Kembali</button>
<div id="view"></div>
</div>

<script>
const { jsPDF } = window.jspdf;
const SHEETS = {
  lembar1: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv"},
  lembar2: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv"},
  lembar3: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv"},
  // URL INVOICE BARU ANDA SUDAH DIPASANG DI SINI:
  invoice: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=1657322319&single=true&output=csv"}
};

let allData = [], currentDetail = [], currentTitle = "", currentPetugas = "Semua", currentSheet = "lembar1";
let historyStack = [], sortState = { key: null, asc: true };

const parseIDR = (val) => {
  if (!val) return 0;
  let clean = String(val).replace(/[^0-9,-]/g, '').split(',')[0];
  return parseFloat(clean) || 0;
};

const parseDate = (str) => {
  if (!str || str === "-") return new Date(0);
  const parts = str.split('-');
  return new Date(parts[2], parts[1] - 1, parts[0]);
};

// PERBAIKAN PENTING: Fungsi isLunas lebih teliti membaca kolom
const isLunas = r => {
    // Cari kolom tgl_lunas (huruf kecil atau besar)
    let val = r.tgl_lunas || r.Tgl_Lunas || r['Tgl Lunas'];
    return val && val.trim() !== "" && val !== "-";
};

// Helper untuk ambil tgl_lunas yang valid
const getTglLunas = r => r.tgl_lunas || r.Tgl_Lunas || r['Tgl Lunas'];

function loadSheet(k) {
  currentSheet = k; historyStack = []; currentPetugas = "Semua"; 
  document.querySelectorAll(".nav-link").forEach(t => t.classList.remove("active"));
  document.getElementById("tab-" + k).classList.add("active");
  view.innerHTML = "<p class='text-center'>Memuat data...</p>";
  fetch(SHEETS[k].url).then(r => r.text()).then(csv => {
    // Parse header tanpa transform case agar aman, kita handle di isLunas
    allData = Papa.parse(csv, {header: true, skipEmptyLines: true}).data;
    renderPetugas();
  });
}

function pushView(fn) { historyStack.push(fn); backBtn.classList.remove("d-none"); }
backBtn.onclick = () => {
  if (historyStack.length > 0) historyStack.pop()();
  if (historyStack.length === 0) { backBtn.classList.add("d-none"); renderPetugas(); }
};

/* ================= FUNGSI TEKS WA ================= */
const getFullText = (r, type) => {
  const date = new Date();
  const nBulanFull = ["JANUARI", "FEBRUARI", "MARET", "APRIL", "MEI", "JUNI", "JULI", "AGUSTUS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DESEMBER"];
  const nBulanShort = ["JAN", "FEB", "MAR", "APR", "MEI", "JUN", "JUL", "AGU", "SEP", "OKT", "NOP", "DES"];
  const blnIniFull = nBulanFull[date.getMonth()];
  const blnIni = `${nBulanShort[date.getMonth()]}-${date.getFullYear()}`;
  const blnLalu = date.getMonth() === 0 ? `DES-${date.getFullYear()-1}` : `${nBulanShort[date.getMonth()-1]}-${date.getFullYear()}`;
  
  if (currentSheet === 'invoice') {
    // ==== FORMAT KHUSUS INVOICE ====
    if (type === 'WA') {
      return encodeURIComponent(
        "*PT. PLN (PERSERO) UID JAWA TENGAH DAN DIY*\n" +
        "*UP3 KLATEN*\n*ULP TULUNG*\n\n" +
        "*PEMBERITAHUAN TAGIHAN LISTRIK*\n" +
        "==========================================\n" +
        "Pelanggan setia PLN,\n" +
        "*Nama* : " + r.nama + "\n" +
        "*GarduTiang* : " + (r.gardu || '-') + "\n" +
        "*Idpel* : " + r.idpel + "\n" +
        "*Koked* : " + r.koked + "\n" +
        "*Alamat* : " + (r.alamat || '-') + "\n" +
        "*Tarif / Daya* : " + r.tarif + " / " + r.daya + "\n" +
        "*No. Kwh* : " + (r.no_kwh || '-') + "\n\n" +
        "Bersama ini kami sampaikan bahwa Jumlah Total tagihan listrik bulan *" + blnIniFull + " " + date.getFullYear() + "* adalah *" + parseIDR(r.jumlah).toLocaleString("id-ID") + "*.\n\n" +
        "Agar terhindar dari pemutusan aliran listrik, kami berharap agar tagihan di atas segera dilunasi.\n" +
        "Batas akhir pembayaran tagihan listrik adalah tanggal 20 setiap bulannya & hari libur transaksi masih bisa dilakukan pada Loket-loket PPOB online.\n\n" +
        "Apabila sampai dengan batas waktu yang ditentukan, tanggal 20 belum lunas, maka akan dilakukan pemutusan aliran listrik.\n" +
        "Demikian atas perhatian dan kerjasamanya diucapkan terimakasih.\n\n" +
        "Tulung, " + date.getDate() + " " + blnIniFull + " " + date.getFullYear() + "\n\n" +
        "*BAYARLAH LISTRIK TANGGAL 1-15 SETIAP BULANNYA*\n" +
        "*PASTI NYAMAN SEMUA SENANG*\n\n" +
        "*MARTONO AJI PRABOWO*\n\n" +
        "_ABAIKAN PEMBERITAHUAN INI JIKA SUDAH MEMBAYAR TAGIHAN_"
      );
    }
    return { tgl: `${date.getDate()} ${blnIniFull} ${date.getFullYear()}`, blnIniFull };

  } else {
    // ==== FORMAT ASLI LEMBAR 1-3 ====
    let periode = (currentSheet === 'lembar1') ? `${blnIni} s/d ${blnIni} (1 LEMBAR)` : `${blnLalu} s/d ${blnIni} (2 LEMBAR)`;
    const body1 = "Dengan ini diberitahukan dengan hormat bahwa pada hari ini aliran listrik di rumah/alamat seperti tersebut diatas terpaksa diputus untuk sementara karena rekening listrik belum dilunasi pada waktu yang telah ditetapkan.";
    const body2 = "Penyambungan kembali akan dilakukan pada setiap hari jam kerja apabila rekening serta biaya keterlambatan dilunasi di tempat penerimaan pembayaran rekening listrik, kantor pos, atau bank yang ditunjuk oleh PLN.";
    const body3 = "Apabila dalam jangka waktu 60 hari terhitung sejak dilakukan pemutusan sementara tunggakan belum dilunasi, maka instalasi milik PLN akan dibongkar, dan penyambungan kembali dapat dilaksanakan setelah Saudara menyelesaikan Biaya Penyambungan yang diperlakukan sebagai sambungan baru serta tetap diwajibkan membayar tagihan listrik yang belum dilunasi beserta dendanya.";

    if (type === 'WA') {
      return encodeURIComponent("*PT. PLN (PERSERO) UID JAWA TENGAH DAN DIY*\n" +
        "*UP3 KLATEN*\n" +
        "*ULP TULUNG*\n\n" +
        "*PEMBERITAHUAN PELAKSANAAN PEMUTUSAN SEMENTARA SAMBUNGAN TENAGA LISTRIK*\n" +
        "==========================================\n" +
        "*Kepada Yth.*\n" +
        "*Nama* : " + r.nama + "\n" +
        "*ID. Pelanggan* : " + r.idpel + "\n" +
        "*Alamat* : " + (r.alamat || '-') + "\n" +
        "*Tarip / Daya* : " + r.tarif + " / " + r.daya + "\n" +
        "*Koked* : " + r.koked + "\n\n" +
        "*Rekening* : " + periode + "\n" +
        "*Rp.* : " + parseIDR(r.rptag).toLocaleString("id-ID") + "\n" +
        "*Jumlah Biaya Keterlambatan s.d bulan : " + blnIni + "*\n" +
        "*Rp.* : " + parseIDR(r.rpbk).toLocaleString("id-ID") + "\n\n" +
        "*Jumlah Tunggakan (belum termasuk biaya Administrasi)*\n" +
        "*Rp.* : *" + parseIDR(r.jumlah).toLocaleString("id-ID") + "*\n\n" +
        body1 + "\n\n" +
        body2 + "\n\n" +
        body3 + "\n\n" +
        "*UNTUK MENGHINDARI RESIKO, MOHON TIDAK TITIP PEMBAYARAN REKENING KEPADA PETUGAS*\n\n" +
        "TULUNG, " + date.getDate() + " " + nBulanFull[date.getMonth()] + " " + date.getFullYear() + "\n" +
        "*MANAGER*\n" +
        "*MARTONO AJI PRABOWO*\n\n" +
        "_ABAIKAN PEMBERITAHUAN INI JIKA SUDAH MEMBAYAR TAGIHAN_");
    }
    return { periode, blnIni, body1, body2, body3, tgl: `${date.getDate()} ${nBulanFull[date.getMonth()]} ${date.getFullYear()}` };
  }
};

/* ================= FUNGSI PDF ================= */
function createPDF(r) {
  const doc = new jsPDF();
  const info = getFullText(r, 'PDF');
  
  if (currentSheet === 'invoice') {
    doc.setFontSize(9);
    doc.text("PT. PLN (PERSERO) UID JAWA TENGAH DAN DIY", 15, 15);
    doc.text(`Petugas : ${r.petugas || '-'}`, 150, 15);
    doc.text("UP3 KLATEN", 15, 19); 
    doc.text("ULP TULUNG", 15, 23);
    
    doc.setFont(undefined, 'bold'); doc.setFontSize(11);
    doc.text("PEMBERITAHUAN TAGIHAN LISTRIK", 105, 33, {align: "center"});
    doc.setFont(undefined, 'normal'); doc.setFontSize(9);
    
    doc.text("Pelanggan setia PLN,", 15, 45);
    doc.text(`Nama             : ${r.nama}`, 15, 52); doc.text(`GarduTiang : ${r.gardu || '-'}`, 120, 52);
    doc.text(`Idpel              : ${r.idpel}`, 15, 57); doc.text(`Koked          : ${r.koked}`, 120, 57);
    doc.text(`Alamat           : ${r.alamat || '-'}`, 15, 62);
    doc.text(`Tarif / Daya   : ${r.tarif} / ${r.daya}`, 15, 67); doc.text(`No. Kwh       : ${r.no_kwh || '-'}`, 120, 67);

    let txt = `Bersama ini kami sampaikan bahwa Jumlah Total tagihan listrik bulan ${info.blnIniFull} 2026 adalah ${parseIDR(r.jumlah).toLocaleString("id-ID")}. Agar terhindar dari pemutusan aliran listrik, kami berharap agar tagihan di atas segera dilunasi.`;
    doc.text(doc.splitTextToSize(txt, 180), 15, 80);

    let txt2 = "Batas akhir pembayaran tagihan listrik adalah tanggal 20 setiap bulannya & hari libur transaksi masih bisa dilakukan pada Loket-loket PPOB online. Apabila sampai dengan batas waktu yang ditentukan, tanggal 20 belum lunas, maka akan dilakukan pemutusan aliran listrik.";
    doc.text(doc.splitTextToSize(txt2, 180), 15, 95);

    doc.text("Demikian atas perhatian dan kerjasamanya diucapkan terimakasih.", 15, 115);
    
    doc.text(`Tulung, ${info.tgl}`, 145, 125);
    doc.setFont(undefined, 'bold');
    doc.text("BAYARLAH LISTRIK TANGGAL 1-15 SETIAP BULANNYA", 15, 135);
    doc.text("PASTI NYAMAN SEMUA SENANG", 15, 140);
    
    doc.text("MARTONO AJI PRABOWO", 145, 150);
    doc.setFontSize(8); doc.setFont(undefined, 'italic');
    doc.text("ABAIKAN PEMBERITAHUAN INI JIKA SUDAH MEMBAYAR TAGIHAN", 15, 160);

  } else {
    // --- PDF LEMBAR 1-3 ---
    doc.setFontSize(8);
    doc.text("PT. PLN (PERSERO) UID JAWA TENGAH DAN DIY", 15, 15);
    doc.text("UP3 KLATEN", 15, 19); doc.text("ULP TULUNG", 15, 23); doc.text("NO. TUL :", 150, 19);
    doc.setFont(undefined, 'bold'); doc.setFontSize(10);
    doc.text("PEMBERITAHUAN PELAKSANAAN PEMUTUSAN SEMENTARA SAMBUNGAN TENAGA LISTRIK", 105, 33, {align: "center"});
    doc.setFont(undefined, 'normal'); doc.setFontSize(9);
    doc.text("===================================================================================", 105, 36, {align: "center"});
    doc.text("Kepada Yth.", 15, 45);
    doc.text(`Nama             : ${r.nama}`, 15, 50);
    doc.text(`ID. Pelanggan    : ${r.idpel}`, 15, 55);
    doc.text(`Alamat           : ${r.alamat || '-'}`, 15, 60);
    doc.text(`Tarip / Daya     : ${r.tarif} / ${r.daya}`, 15, 65);
    doc.text(`Koked : ${r.koked}`, 120, 55);
    doc.text(`Rekening : ${info.periode}`, 15, 80);
    doc.text(`Rp. :`, 150, 80); doc.text(parseIDR(r.rptag).toLocaleString("id-ID"), 190, 80, {align: "right"});
    doc.text(`Jumlah Biaya Keterlambatan s.d bulan : ${info.blnIni}`, 15, 85);
    doc.text(`Rp. :`, 150, 85); doc.text(parseIDR(r.rpbk).toLocaleString("id-ID"), 190, 85, {align: "right"});
    doc.setFont(undefined, 'bold');
    doc.text(`Jumlah Tunggakan (belum termasuk biaya Administrasi)`, 15, 92);
    doc.text(`Rp. :`, 150, 92); doc.text(parseIDR(r.jumlah).toLocaleString("id-ID"), 190, 92, {align: "right"});
    doc.setFont(undefined, 'normal'); doc.setFontSize(8.5);
    let p1 = doc.splitTextToSize(info.body1, 180); doc.text(p1, 15, 102);
    let p2 = doc.splitTextToSize(info.body2, 180); doc.text(p2, 15, 114);
    let p3 = doc.splitTextToSize(info.body3, 180); doc.text(p3, 15, 130);
    doc.setFont(undefined, 'bold');
    doc.text("UNTUK MENGHINDARI RESIKO, MOHON TIDAK TITIP PEMBAYARAN REKENING KEPADA PETUGAS", 15, 150);
    doc.text(`TULUNG, ${info.tgl}`, 145, 160);
    doc.text("MANAGER", 155, 165);
    doc.text("MARTONO AJI PRABOWO", 145, 190);
    doc.setFontSize(7); doc.setFont(undefined, 'normal');
    doc.text("A5 TUL VI-01/PETUGAS PEMUTUS : ..................................", 15, 210);
  }
  
  doc.save(`${currentSheet === 'invoice' ? 'Tagihan' : 'TUL'}_${r.idpel}.pdf`);
}

/* ================= ALUR DATA ================= */
function renderPetugas() {
  const map = {}; let totalRp = 0;
  allData.forEach(r => {
    let pName = r.petugas || "Tanpa Nama";
    map[pName] = map[pName] || {j: 0, rp: 0};
    map[pName].j++; map[pName].rp += parseIDR(r.jumlah); totalRp += parseIDR(r.jumlah);
  });
  const sorted = Object.keys(map).sort().map(p => ({name: p, ...map[p]}));
  let h = `<div class="table-responsive"><table class="table table-bordered"><thead class="table-dark"><tr><th>Petugas</th><th>Jml</th><th>Total Rp</th></tr></thead><tbody><tr class="table-primary clickable" onclick="openGlobal()"><td><b>SEMUA</b></td><td><b>${allData.length}</b></td><td class="text-end"><b>${totalRp.toLocaleString("id-ID")}</b></td></tr>`;
  sorted.forEach(p => { h += `<tr class="clickable" onclick="openPetugas('${p.name}')"><td>${p.name}</td><td>${p.j}</td><td class="text-end">${p.rp.toLocaleString("id-ID")}</td></tr>`; });
  view.innerHTML = h + `</tbody></table></div>`;
}

function openPetugas(p) {
  currentPetugas = p; pushView(renderPetugas);
  const data = allData.filter(r => r.petugas === p);
  const lunas = data.filter(isLunas), belum = data.filter(r => !isLunas(r)), byDate = {};
  
  // Perbaikan: Pakai getTglLunas() untuk grouping tanggal
  lunas.forEach(r => { 
    let t = getTglLunas(r);
    byDate[t] = byDate[t] || {j: 0, rp: 0}; 
    byDate[t].j++; byDate[t].rp += parseIDR(r.jumlah); 
  });
  
  let h = `<h6 class="text-primary fw-bold">Petugas: ${p}</h6><div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-success"><tr><th>Tanggal</th><th>Plg</th><th>Total Rp</th></tr></thead><tbody>`;
  if (belum.length > 0) h += `<tr class="clickable" onclick="detailBelum()"><td>BELUMLUNAS</td><td>${belum.length}</td><td class="text-end">${belum.reduce((a,b)=>a+parseIDR(b.jumlah),0).toLocaleString("id-ID")}</td></tr>`;
  Object.keys(byDate).sort((a,b) => parseDate(b) - parseDate(a)).forEach(t => { h += `<tr class="clickable" onclick="detailLunas('${t}')"><td>${t}</td><td>${byDate[t].j}</td><td class="text-end">${byDate[t].rp.toLocaleString("id-ID")}</td></tr>`; });
  view.innerHTML = h + `</tbody></table></div>`;
}

function openGlobal() {
  currentPetugas = "Semua"; pushView(renderPetugas);
  const lunas = allData.filter(isLunas), belum = allData.filter(r => !isLunas(r)), byDate = {};
  lunas.forEach(r => { 
    let t = getTglLunas(r);
    byDate[t] = byDate[t] || {j: 0, rp: 0}; 
    byDate[t].j++; byDate[t].rp += parseIDR(r.jumlah); 
  });
  let h = `<h6 class="text-primary fw-bold">Semua Petugas</h6><div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-success"><tr><th>Tanggal</th><th>Plg</th><th>Total Rp</th></tr></thead><tbody>`;
  if (belum.length > 0) h += `<tr class="clickable" onclick="detailBelum()"><td>BELUMLUNAS</td><td>${belum.length}</td><td class="text-end">${belum.reduce((a,b)=>a+parseIDR(b.jumlah),0).toLocaleString("id-ID")}</td></tr>`;
  Object.keys(byDate).sort((a,b) => parseDate(b) - parseDate(a)).forEach(t => { h += `<tr class="clickable" onclick="detailGlobalLunas('${t}')"><td>${t}</td><td>${byDate[t].j}</td><td class="text-end">${byDate[t].rp.toLocaleString("id-ID")}</td></tr>`; });
  view.innerHTML = h + `</tbody></table></div>`;
}

function detailLunas(t) { currentTitle = `Lunas_${t}`; currentDetail = allData.filter(r => r.petugas === currentPetugas && isLunas(r) && getTglLunas(r) === t); pushView(()=>openPetugas(currentPetugas)); renderDetail(); }
function detailBelum() { currentTitle = "Belum_Lunas"; const p = currentPetugas; currentDetail = allData.filter(r => (p === "Semua" ? true : r.petugas === p) && !isLunas(r)); pushView(()=>(p==="Semua"?openGlobal():openPetugas(p))); renderDetail(); }
function detailGlobalLunas(t) { currentTitle = `Global_Lunas_${t}`; currentDetail = allData.filter(r => isLunas(r) && getTglLunas(r) === t); pushView(openGlobal); renderDetail(); }

function renderDetail() {
  sortState = { key: null, asc: true };
  view.innerHTML = `<h6 class="text-center fw-bold small text-uppercase">${currentTitle.replace(/_/g,' ')}</h6><div class="d-flex mb-2 gap-1"><input id="search" class="form-control form-control-sm" placeholder="Cari..."><button class="btn btn-success btn-sm" onclick="exportExcel()">XLSX</button></div><div id="tableArea"></div>`;
  document.getElementById("search").oninput = e => {
    const t = e.target.value.toLowerCase();
    drawTable(currentDetail.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(t))));
  };
  drawTable(currentDetail);
}

function drawTable(data) {
  window.triggerSort = (key) => {
    if (sortState.key === key) sortState.asc = !sortState.asc; else { sortState.key = key; sortState.asc = true; }
    const sorted = [...data].sort((a, b) => {
      let v1 = a[key] || "", v2 = b[key] || "";
      if (key === 'jumlah') return sortState.asc ? parseIDR(v1) - parseIDR(v2) : parseIDR(v2) - parseIDR(v1);
      return sortState.asc ? String(v1).localeCompare(String(v2), undefined, {numeric: true}) : String(v2).localeCompare(String(v1), undefined, {numeric: true});
    });
    drawTable(sorted);
  };
  const icon = (k) => sortState.key === k ? (sortState.asc ? ' â–²' : ' â–¼') : '';
  let h = `<div class="table-responsive"><table class="table table-sm table-bordered" style="font-size:0.7rem"><thead class="table-primary text-nowrap"><tr><th class="clickable" onclick="triggerSort('idpel')">IDPEL${icon('idpel')}</th><th class="clickable" onclick="triggerSort('nama')">Nama${icon('nama')}</th><th class="clickable" onclick="triggerSort('koked')">Koked${icon('koked')}</th><th class="clickable" onclick="triggerSort('jumlah')">Rp${icon('jumlah')}</th></tr></thead><tbody>`;
  data.forEach(r => { h += `<tr class="clickable" onclick="showCardsByData('${r.idpel}')"><td>${r.idpel}</td><td>${r.nama}</td><td>${r.koked}</td><td class="text-end">${parseIDR(r.jumlah).toLocaleString("id-ID")}</td></tr>`; });
  document.getElementById("tableArea").innerHTML = h + `</tbody></table></div>`;
}

function showCardsByData(id) {
  pushView(renderDetail);
  let h = "";
  currentDetail.forEach(r => {
    h += `<div class="card mb-2 ${r.idpel === id?'highlight':''}" id="card-${r.idpel}"><div class="card-body p-2">
      <div class="d-flex justify-content-between"><b>${r.nama}</b> <span class="badge bg-light text-dark">${r.koked}</span></div>
      <p class="text-muted mb-1">${r.idpel} | ${r.tarif}/${r.daya} | ${r.alamat || '-'}</p>
      <div class="d-flex justify-content-between align-items-center">
        <b class="text-danger">Rp ${parseIDR(r.jumlah).toLocaleString("id-ID")}</b>
        <div class="d-flex gap-1">
          <a class="btn btn-success btn-sm" target="_blank" href="https://wa.me/?text=${getFullText(r, 'WA')}">ðŸ“¤ WA</a>
          <button class="btn btn-danger btn-sm" onclick='createPDF(${JSON.stringify(r)})'>ðŸ“„ PDF</button>
        </div>
      </div>
    </div></div>`;
  });
  view.innerHTML = h;
  if(id) setTimeout(() => document.getElementById(`card-${id}`).scrollIntoView({behavior:'smooth', block:'center'}), 100);
}

function exportExcel() {
  const ws = XLSX.utils.json_to_sheet(currentDetail), wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Data");
  XLSX.writeFile(wb, `Rekap_${currentTitle}.xlsx`);
}

loadSheet("lembar1");
</script>
</body>
</html>
